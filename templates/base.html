<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dave Chatbot{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    {% block extra_head %}{% endblock %} {# Placeholder for extra head content specific to a page #}
</head>
<body>
    <div class="container">
    <div class="header">
        <div class="header-left">{% block header_left %}{% endblock %}</div>
        <h1>{% block header_title %}Dave Chatbot{% endblock %}</h1>
        <div id="hamburger-icon" class="hamburger-icon"> {# REMOVED: style="display: none;" #}
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
    </div>

    {# This is where the unique content of each page will go #}
    {% block content %}{% endblock %}
</div>

    <div id="side-menu" class="side-menu">
        <button id="close-menu-btn" class="close-menu-btn">&times;</button>
        <a href="/new_chat" class="menu-item">New Chat</a> {# NEW CHAT LINK #}
        <a href="/profile" class="menu-item">User Profile</a>
        <a href="/settings" class="menu-item">Settings</a>
        <a href="/about" class="menu-item">About Dave</a>
        <a href="#" id="menu-logout-link" class="menu-item">Logout</a> {# Existing Logout link #}
    </div>

    <script>
        // --- Common JavaScript Elements and Functions (now in base.html) ---
        const hamburgerIcon = document.getElementById('hamburger-icon');
        const sideMenu = document.getElementById('side-menu');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const menuLogoutLink = document.getElementById('menu-logout-link');

        // This function will be defined here, but `authSection` and `chatSection`
        // will only exist on `index.html`. We'll handle null checks.
        function showSection(section) {
            const authSection = document.getElementById('auth-section');
            const chatSection = document.getElementById('chat-section');

            if (authSection) authSection.style.display = 'none';
            if (chatSection) chatSection.style.display = 'none';

            if (section === 'auth') {
                if (authSection) authSection.style.display = 'block';
            } else if (section === 'chat') {
                if (chatSection) chatSection.style.display = 'flex';
            }
        }

        // Parse bot message (moved here as it's common)
        function parseBotMessage(text) {
            let safeText = text.replace(/&/g, '&amp;')
                               .replace(/</g, '&lt;')
                               .replace(/>/g, '&gt;')
                               .replace(/"/g, '&#039;');
            safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            safeText = safeText.replace(/\*(.*?)\*/g, '<em>$1</em>');
            safeText = safeText.replace(/\n/g, '<br>');
            return safeText;
        }

        // Logout function for the menu item
        if (menuLogoutLink) {
            menuLogoutLink.addEventListener('click', async (e) => {
                e.preventDefault(); // Prevent default link behavior
                try {
                    const response = await fetch('/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (response.ok) {
                        alert('Logged out successfully.');
                        window.location.href = '/'; // Redirect to home page (which will show auth)
                    } else {
                        const result = await response.json();
                        alert(result.error || 'Failed to logout.');
                    }
                } catch (error) {
                    console.error('Logout Error:', error);
                    alert('An error occurred during logout.');
                }
            });
        }

        // checkLoginStatus (moved here as it's common)
        async function checkLoginStatus() {
            try {
                const response = await fetch('/check_login_status');
                const result = await response.json();

                if (response.ok && result.logged_in) {
                    hamburgerIcon.style.display = 'flex';
                    sideMenu.style.display = 'flex';

                    // If on the main chat page, `index.html`'s DOMContentLoaded will handle display and greeting
                    if (window.location.pathname === '/') {
                        showSection('chat'); // Ensure the chat section is visible
                        // Removed: chatBox.innerHTML = ''; -- This is now handled in index.html
                    }
                } else {
                    hamburgerIcon.style.display = 'none';
                    sideMenu.style.display = 'none';

                    // If on the main chat page, show auth section and reset its state
                    if (window.location.pathname === '/') {
                        showSection('auth');
                        // Removed: auth form reset logic. This is now handled by index.html's populateChatBoxWithHistoryOrGreeting().
                    }
                    // For other pages (profile, settings), they just won't show the menu
                }
            } catch (error) {
                console.error('Login Status Check Error:', error);
                hamburgerIcon.style.display = 'none';
                sideMenu.style.display = 'none';
                // Removed: auth form reset logic here too. index.html handles it.
                if (window.location.pathname === '/') {
                    showSection('auth');
                }
            }
        }

        // Hamburger Menu Logic (now in base.html)
        hamburgerIcon.addEventListener('click', () => {
            sideMenu.classList.add('open');
        });

        closeMenuBtn.addEventListener('click', () => {
            sideMenu.classList.remove('open');
        });

        document.addEventListener('click', (event) => {
            if (sideMenu.classList.contains('open') &&
                !sideMenu.contains(event.target) &&
                !hamburgerIcon.contains(event.target)) {
                sideMenu.classList.remove('open');
            }
        });

        // Initial DOMContentLoaded event listener (common across all pages)
        // This will be overridden by index.html's own DOMContentLoaded for the chat page.
        // For other pages (profile, settings, about), this ensures basic login status is checked.
        document.addEventListener('DOMContentLoaded', () => {
             // Only run checkLoginStatus from base.html if it's NOT the index page.
             // The index page handles its initial state more comprehensively itself.
            if (window.location.pathname !== '/') {
                checkLoginStatus(); 
            }
        });

        // --- END Common JavaScript ---

        // {# Placeholder for extra JavaScript specific to a page #}
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>