{% extends 'base.html' %}

{% block title %}Dave Chatbot - Home{% endblock %}

{% block content %}
    <div id="auth-section" class="auth-section">
        <h2 id="auth-title">Welcome! Please log in or register.</h2>
        <form id="auth-form">
            <div class="input-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required autocomplete="username">
            </div>
            <div class="input-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required autocomplete="current-password">
            </div>
            <div class="input-group" id="confirm-password-group">
                <label for="confirm-password">Confirm Password:</label>
                <input type="password" id="confirm-password" name="confirm-password" autocomplete="new-password">
            </div>
            <button type="submit" id="auth-button">Login</button>
            <p id="auth-message" class="message"></p>
            <div class="toggle-auth">
                <a href="#" id="toggle-auth-link">Don't have an account? Register</a>
            </div>
        </form>
    </div>

    <div id="chat-section" class="chat-section">
        <div class="chat-box" id="chat-box">
            </div>
        <form id="chat-form" class="chat-input">
            <input type="text" id="user-input" placeholder="Type your message...">
            <button type="submit">Send</button>
        </form>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        const authSection = document.getElementById('auth-section');
        const chatSection = document.getElementById('chat-section');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const confirmPasswordGroup = document.getElementById('confirm-password-group');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const authButton = document.getElementById('auth-button');
        const authMessage = document.getElementById('auth-message');
        const toggleAuthLink = document.getElementById('toggle-auth-link');
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');

        let isRegisterMode = false;

        function resetAuthFormToLoginMode() {
            isRegisterMode = false;
            authButton.textContent = 'Login';
            toggleAuthLink.textContent = 'Don\'t have an account? Register';
            if (confirmPasswordGroup) confirmPasswordGroup.style.display = 'none';
            if (confirmPasswordInput) confirmPasswordInput.value = '';
            authTitle.textContent = 'Welcome! Please log in or register.';
            passwordInput.setAttribute('autocomplete', 'current-password');
            usernameInput.value = '';
            passwordInput.value = '';
            authMessage.textContent = '';
        }

        async function handleAuthResponse(response, result, isRegisterAttempt) {
            if (response.ok) {
                authMessage.textContent = result.message;
                authMessage.style.color = 'green';
                
                if (isRegisterAttempt) {
                    resetAuthFormToLoginMode();
                    authTitle.textContent = 'Registration successful! Please log in.';
                    setTimeout(() => {
                        authMessage.textContent = '';
                    }, 3000);
                } else {
                    // Successful login
                    setTimeout(() => {
                        showSection('chat');
                        // Make hamburger icon and side menu visible
                        if (hamburgerIcon) hamburgerIcon.style.display = 'flex';
                        if (sideMenu) sideMenu.style.display = 'flex';
                        populateChatBoxWithHistoryOrGreeting();
                    }, 500);
                }
            } else {
                authMessage.textContent = result.error || 'Authentication failed.';
                authMessage.style.color = 'red';
            }
        }

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authMessage.textContent = '';

            const username = usernameInput.value;
            const password = passwordInput.value;
            let endpoint = '';
            let isRegisterAttempt = false;

            if (isRegisterMode) {
                isRegisterAttempt = true;
                const confirmPassword = confirmPasswordInput.value;
                if (password !== confirmPassword) {
                    authMessage.textContent = 'Passwords do not match.';
                    authMessage.style.color = 'red';
                    return;
                }
                endpoint = '/register';
            } else {
                endpoint = '/login';
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                const result = await await response.json(); // Await twice, fix from prev bug
                await handleAuthResponse(response, result, isRegisterAttempt);

            } catch (error) {
                console.error('Authentication Error:', error);
                authMessage.textContent = 'An error occurred. Please try again.';
                authMessage.style.color = 'red';
            }
        });

        toggleAuthLink.addEventListener('click', (e) => {
            e.preventDefault();
            isRegisterMode = !isRegisterMode;
            authMessage.textContent = '';
            passwordInput.value = '';
            confirmPasswordInput.value = '';

            if (isRegisterMode) {
                authButton.textContent = 'Register';
                toggleAuthLink.textContent = 'Already have an account? Login';
                confirmPasswordGroup.style.display = 'block';
                authTitle.textContent = 'Create Your Account';
                passwordInput.setAttribute('autocomplete', 'new-password');
                confirmPasswordInput.setAttribute('autocomplete', 'new-password');
            } else {
                resetAuthFormToLoginMode();
            }
        });

        function addMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender);
            messageElement.innerHTML = parseBotMessage(message);
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (message) {
                addMessage('user', message);
                userInput.value = '';

                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message }),
                    });

                    if (response.status === 401) {
                        alert('Your session has expired. Please log in again.');
                        window.location.href = '/';
                        return;
                    }

                    const result = await response.json();
                    if (response.ok) {
                        addMessage('bot', result.response);
                    } else {
                        addMessage('bot', result.error || 'Oops, something went wrong!');
                    }
                } catch (error) {
                    console.error('Chat Error:', error);
                    addMessage('bot', 'Failed to connect to the chatbot. Please try again.');
                }
            }
        });

        async function populateChatBoxWithHistoryOrGreeting() {
            try {
                const response = await fetch('/check_login_status');
                const result = await response.json();

                if (response.ok && result.logged_in) {
                    showSection('chat');
                    // Ensure hamburger icon and side menu are visible on successful load
                    if (hamburgerIcon) hamburgerIcon.style.display = 'flex';
                    if (sideMenu) sideMenu.style.display = 'flex';
                    
                    chatBox.innerHTML = ''; // Always clear before populating

                    const chatHistory = result.chat_history;

                    if (chatHistory && chatHistory.length > 0) {
                        chatHistory.forEach(msg => {
                            addMessage(msg.role, msg.parts[0]);
                        });
                    } else {
                        addMessage('bot', `Welcome back, ${result.username}! How can I help you today?`);
                    }
                } else {
                    showSection('auth');
                    resetAuthFormToLoginMode();
                    // Ensure hamburger icon and side menu are hidden if not logged in
                    if (hamburgerIcon) hamburgerIcon.style.display = 'none';
                    if (sideMenu) sideMenu.style.display = 'none';
                }
            } catch (error) {
                console.error("Error during initial page load/login status check:", error);
                showSection('auth');
                resetAuthFormToLoginMode();
                // Ensure hamburger icon and side menu are hidden on error
                if (hamburgerIcon) hamburgerIcon.style.display = 'none';
                if (sideMenu) sideMenu.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateChatBoxWithHistoryOrGreeting();
        });

    </script>
{% endblock %}