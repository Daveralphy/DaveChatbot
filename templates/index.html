{% extends 'base.html' %}

{% block title %}Dave Chatbot - Home{% endblock %}

{% block content %}
    {# Your existing auth and chat sections are now within the 'content' block #}
    <div id="auth-section" class="auth-section">
        <h2 id="auth-title">Welcome! Please log in or register.</h2>
        <form id="auth-form">
            <div class="input-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required autocomplete="username">
            </div>
            <div class="input-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required autocomplete="current-password">
            </div>
            <div class="input-group" id="confirm-password-group">
                <label for="confirm-password">Confirm Password:</label>
                <input type="password" id="confirm-password" name="confirm-password" autocomplete="new-password">
            </div>
            <button type="submit" id="auth-button">Login</button>
            <p id="auth-message" class="message"></p>
            <div class="toggle-auth">
                <a href="#" id="toggle-auth-link">Don't have an account? Register</a>
            </div>
        </form>
    </div>

    <div id="chat-section" class="chat-section">
        <div class="chat-box" id="chat-box">
            </div>
        <form id="chat-form" class="chat-input">
            <input type="text" id="user-input" placeholder="Type your message...">
            <button type="submit">Send</button>
        </form>
        <button id="logout-button" class="logout-button">Logout</button>
    </div>
{% endblock %}

{% block extra_js %}
    {# JavaScript specific to the index (chat) page #}
    <script>
        // Get elements specific to index.html (auth and chat elements)
        const authSection = document.getElementById('auth-section');
        const chatSection = document.getElementById('chat-section');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const confirmPasswordGroup = document.getElementById('confirm-password-group');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const authButton = document.getElementById('auth-button');
        const authMessage = document.getElementById('auth-message');
        const toggleAuthLink = document.getElementById('toggle-auth-link');
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const logoutButton = document.getElementById('logout-button');

        // isRegisterMode needs to be managed locally or globally if `checkLoginStatus` relied on it
        // Since it's mainly for `authForm` and `toggleAuthLink`, it can remain in this scope.
        let isRegisterMode = false;

        // Authentication Functions (specific to index.html's auth form)
        async function handleAuthResponse(response, result, isRegisterAttempt) {
            if (response.ok) {
                authMessage.textContent = result.message;
                authMessage.style.color = 'green';
                usernameInput.value = '';
                passwordInput.value = '';
                confirmPasswordInput.value = '';

                if (isRegisterAttempt) {
                    isRegisterMode = false;
                    authButton.textContent = 'Login';
                    toggleAuthLink.textContent = 'Don\'t have an account? Register';
                    confirmPasswordGroup.style.display = 'none';
                    authTitle.textContent = 'Registration successful! Please log in.';
                    passwordInput.setAttribute('autocomplete', 'current-password');
                    setTimeout(() => {
                        authMessage.textContent = '';
                    }, 3000);
                } else {
                    setTimeout(() => {
                        showSection('chat'); // `showSection` is from base.html
                        chatBox.innerHTML = '';
                        addMessage('bot', `Hi there! I'm Dave. How can I help you today?`);
                        hamburgerIcon.style.display = 'flex'; // `hamburgerIcon` is from base.html
                        sideMenu.style.display = 'flex';     // `sideMenu` is from base.html
                    }, 500);
                }
            } else {
                authMessage.textContent = result.error || 'Authentication failed.';
                authMessage.style.color = 'red';
            }
        }

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authMessage.textContent = '';

            const username = usernameInput.value;
            const password = passwordInput.value;
            let endpoint = '';
            let isRegisterAttempt = false;

            if (isRegisterMode) {
                isRegisterAttempt = true;
                const confirmPassword = confirmPasswordInput.value;
                if (password !== confirmPassword) {
                    authMessage.textContent = 'Passwords do not match.';
                    authMessage.style.color = 'red';
                    return;
                }
                endpoint = '/register';
            } else {
                endpoint = '/login';
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                const result = await response.json();
                await handleAuthResponse(response, result, isRegisterAttempt);

            } catch (error) {
                console.error('Authentication Error:', error);
                authMessage.textContent = 'An error occurred. Please try again.';
                authMessage.style.color = 'red';
            }
        });

        toggleAuthLink.addEventListener('click', (e) => {
            e.preventDefault();
            isRegisterMode = !isRegisterMode;
            authMessage.textContent = '';
            passwordInput.value = '';
            confirmPasswordInput.value = '';

            if (isRegisterMode) {
                authButton.textContent = 'Register';
                toggleAuthLink.textContent = 'Already have an account? Login';
                confirmPasswordGroup.style.display = 'block';
                authTitle.textContent = 'Create Your Account';
                passwordInput.setAttribute('autocomplete', 'new-password');
                confirmPasswordInput.setAttribute('autocomplete', 'new-password');
            } else {
                authButton.textContent = 'Login';
                toggleAuthLink.textContent = 'Don\'t have an account? Register';
                confirmPasswordGroup.style.display = 'none';
                confirmPasswordInput.value = '';
                authTitle.textContent = 'Welcome! Please log in or register.';
                passwordInput.setAttribute('autocomplete', 'current-password');
            }
        });

        // Chat Functions (specific to index.html)
        function addMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender);
            messageElement.innerHTML = parseBotMessage(message); // `parseBotMessage` is from base.html
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (message) {
                addMessage('user', message);
                userInput.value = '';

                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message }),
                    });

                    if (response.status === 401) {
                        alert('Your session has expired. Please log in again.');
                        showSection('auth'); // `showSection` is from base.html
                        return;
                    }

                    const result = await response.json();
                    if (response.ok) {
                        addMessage('bot', result.response);
                    } else {
                        addMessage('bot', result.error || 'Oops, something went wrong!');
                    }
                } catch (error) {
                    console.error('Chat Error:', error);
                    addMessage('bot', 'Failed to connect to the chatbot. Please try again.');
                }
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    alert('Logged out successfully.');
                    showSection('auth'); // `showSection` is from base.html
                    sideMenu.classList.remove('open'); // `sideMenu` is from base.html
                    hamburgerIcon.style.display = 'none'; // `hamburgerIcon` is from base.html
                    sideMenu.style.display = 'none'; // `sideMenu` is from base.html
                } else {
                    const result = await response.json();
                    alert(result.error || 'Failed to logout.');
                }
            } catch (error) {
                console.error('Logout Error:', error);
                alert('An error occurred during logout.');
            }
        });

        // Initial greeting on chat page ONLY after DOM is fully loaded AND user is logged in
        document.addEventListener('DOMContentLoaded', async () => {
            // checkLoginStatus already called from base.html, it handles general visibility
            // We need to fetch login status again here to get `result.username`
            try {
                const response = await fetch('/check_login_status');
                const result = await response.json();
                if (response.ok && result.logged_in) {
                    // Only add greeting if chatbox is active and empty (to prevent re-adding on soft refresh)
                    if (chatBox.style.display !== 'none' && chatBox.children.length === 0) {
                        addMessage('bot', `Welcome back, ${result.username}! How can I help you today?`);
                    }
                }
            } catch (error) {
                console.error("Error checking login status for initial greeting:", error);
            }
        });

    </script>
{% endblock %}